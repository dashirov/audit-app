<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Analytics Maturity Assessment</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #rubric-container { display: flex; flex-direction: column; gap: 15px; }
        .category-card {
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            background: #f9f9f9;
            cursor: move;
        }
        .card-header {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
        }
        .category-header {
            font-size: 1.2em;
            font-weight: bold;
        }
        .priority-label {
            font-weight: bold;
        }
        .row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .horizontal-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        select {
            padding: 5px;
        }
        .rounded-text {
            background-color: #e6f7ff;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
            white-space: nowrap;
        }
        .star-rating {
            color: gold;
            font-size: 1.2em;
        }
        .narrative-label {
            font-weight: bold;
            display: block;
        }
        .narrative-input {
            width: 95%;
            height: 100px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-family: Arial, sans-serif;
        }
        .category-objective {
            margin-top: 5px;
            font-style: italic;
            color: #333;
        }
        .category-activities {
            margin-top: 3px;
            font-size: 0.9em;
            color: #555;
        }
        .category-activities ul {
            padding-left: 20px;
            margin: 0;
        }
        .category-activities li {
            text-align: left;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
<h1>Product Analytics Maturity Assessment</h1>
<div id="rubric-container"></div>

<script>
    let rubricData = [];
    let subjectData = {};

    Promise.all([
        fetch('/rubric').then(res => res.json()),
        fetch('/subject').then(res => res.json())
    ]).then(([rubric, subjects]) => {
        rubricData = rubric;
        subjects.forEach(s => subjectData[s.Category] = s);
        renderRubric();
    });

    function renderRubric() {
        const grouped = rubricData.reduce((acc, item) => {
            if (!acc[item.Category]) acc[item.Category] = [];
            acc[item.Category].push(item);
            return acc;
        }, {});

        const container = document.getElementById("rubric-container");
        container.innerHTML = "";

        Object.entries(grouped).forEach(([category, levels], idx) => {
            const card = document.createElement("div");
            card.className = "category-card";
            card.draggable = true;
            card.dataset.category = category;

            const header = document.createElement("div");
            header.className = "card-header";
            header.innerHTML = `<div class="category-header">${category}</div>
                             <div class="priority-label">Improvement Priority: <span class="priority">${idx + 1}</span></div>`;

            const subject = subjectData[category] || {};
            const objective = document.createElement("div");
            objective.className = "category-objective";
            objective.innerText = "Objective: " + (subject.Objective || "Not defined");

            const activities = document.createElement("div");
            activities.className = "category-activities";
            const activityItems = (subject.Activities || "")
                .split(/- /)  // split on line breaks or dashes or bullets
                .map(item => item.trim())
                .filter(item => item.length > 0);
            activities.innerHTML = `<strong>Activities:</strong><ul>` +
                activityItems.map(item => `<li>${item}</li>`).join('') +
                `</ul>`;

            header.insertBefore(objective, header.children[1]);  // before priority
            header.insertBefore(activities, header.children[2]); // also before priority

            const row = document.createElement("div");
            row.className = "row";

            // Observations Column
            const obsCol = document.createElement("div");
            obsCol.className = "column";
            const obsSelect = document.createElement("select");
            obsSelect.innerHTML = '<option value="">Select Maturity Level</option>' +
                levels.map(l => `<option value="${l.Score}">${l.Description}</option>`).join('');
            const obsRating = document.createElement("div");
            obsRating.innerHTML = `
          <div class="star-rating">${'&#9734;'.repeat(5)}</div>
          <div class="rounded-text">Not Assessed</div>`;

            const obsNarrative = document.createElement("div");
            obsNarrative.innerHTML = `
          <label class="narrative-label">Narrative & Supporting Evidence:</label>
          <div class="narrative-input" contenteditable="true"></div>
        `;

            obsSelect.addEventListener("change", () => {
                const selected = levels.find(l => l.Score == obsSelect.value);
                if (selected) {
                    obsRating.innerHTML = `
              <div class="star-rating">${'&#9733;'.repeat(selected.Score)}${'&#9734;'.repeat(5 - selected.Score)}</div>
              <div class="rounded-text">${selected["Maturity Level"]}</div>`;

                    tgtSelect.innerHTML = '<option value="">Target Maturity Level</option>' +
                        levels.filter(l => l.Score >= selected.Score)
                            .map(l => `<option value="${l.Score}">${l.Description}</option>`).join('');
                } else {
                    obsRating.innerHTML = `
              <div class="star-rating">${'&#9734;'.repeat(5)}</div>
              <div class="rounded-text">Not Assessed</div>`;
                    tgtSelect.innerHTML = '<option value="">Target Maturity Level</option>';
                }
            });

            // Improvement Plan Column
            const tgtCol = document.createElement("div");
            tgtCol.className = "column";
            const tgtSelect = document.createElement("select");
            tgtSelect.innerHTML = '<option value="">Target Maturity Level</option>';
            const tgtRating = document.createElement("div");
            tgtRating.innerHTML = `
          <div class="star-rating">${'&#9734;'.repeat(5)}</div>
          <div class="rounded-text">Not Assessed</div>`;
            const tgtNarrative = document.createElement("div");
            tgtNarrative.innerHTML = `
          <label class="narrative-label">Improvement Plan Narrative:</label>
          <div class="narrative-input" contenteditable="true"></div>
        `;

            tgtSelect.addEventListener("change", () => {
                const selected = levels.find(l => l.Score == tgtSelect.value);
                if (selected) {
                    tgtRating.innerHTML = `
              <div class="star-rating">${'&#9733;'.repeat(selected.Score)}${'&#9734;'.repeat(5 - selected.Score)}</div>
              <div class="rounded-text">${selected["Maturity Level"]}</div>`;
                } else {
                    tgtRating.innerHTML = `
              <div class="star-rating">${'&#9734;'.repeat(5)}</div>
              <div class="rounded-text">Not Assessed</div>`;
                }
            });

            obsCol.append(obsSelect, obsRating,obsNarrative);
            tgtCol.append(tgtSelect, tgtRating, tgtNarrative);
            row.append(obsCol, tgtCol);

            card.append(header, row);
            container.appendChild(card);
        });

        makeSortable(container);
    }

    function makeSortable(container) {
        let draggingEl;
        container.addEventListener("dragstart", e => {
            draggingEl = e.target;
            e.dataTransfer.effectAllowed = "move";
        });
        container.addEventListener("dragover", e => {
            e.preventDefault();
            const afterEl = getDragAfterElement(container, e.clientY);
            if (afterEl == null) {
                container.appendChild(draggingEl);
            } else {
                container.insertBefore(draggingEl, afterEl);
            }
            updatePriorities(container);
        });
    }

    function getDragAfterElement(container, y) {
        const elements = [...container.querySelectorAll('.category-card:not(.dragging)')];
        return elements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            return offset < 0 && offset > closest.offset ? { offset, element: child } : closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updatePriorities(container) {
        const cards = container.querySelectorAll('.category-card');
        cards.forEach((card, index) => {
            const prioritySpan = card.querySelector('.priority');
            if (prioritySpan) prioritySpan.textContent = index + 1;
        });
    }
</script>
</body>
</html>
